<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>Catalog Viewer</title>
    <link rel="icon" type="image/png" href="icon/32.png" />
    <style>
      /* ================= GLOBAL & LAYOUT ================= */
      :root {
        --header-height: 60px;
        --sidebar-width: 280px;
        --accent-color: #000; /* Black for neutrality */
        --bg-color: #ffffff;
      }
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      body {
        margin: 0;
        padding: 0;
        padding-top: var(--header-height);
        padding-bottom: 90px;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        background: var(--bg-color);
        color: #333;
        -webkit-font-smoothing: antialiased;
      }
      a {
        text-decoration: none;
        color: inherit;
      }
      button {
        outline: none;
        border: none;
        background: none;
        font-family: inherit;
      }

      /* ================= HEADER ================= */
      .site-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: var(--header-height);
        background-color: #fff;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        padding: 0 15px;
        z-index: 1000;
        justify-content: space-between;
      }
      .header-left {
        display: flex;
        align-items: center;
        font-size: 1.2rem;
        cursor: pointer;
      }
      .header-center {
        flex: 1;
        margin: 0 15px;
      }
      .header-search-input {
        width: 100%;
        background: #f5f5f5;
        border: none;
        padding: 10px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        outline: none;
      }

      /* ================= SIDEBAR ================= */
      .sidebar-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: 0.3s;
      }
      .sidebar-overlay.active {
        opacity: 1;
        visibility: visible;
      }
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: var(--sidebar-width);
        background: #fff;
        z-index: 2001;
        transform: translateX(-100%);
        transition: 0.3s;
        padding: 20px;
        overflow-y: auto;
      }
      .sidebar.active {
        transform: translateX(0);
      }
      .menu-link {
        display: block;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
        font-weight: 600;
      }
      .brand-item {
        padding: 10px 5px;
        color: #555;
        cursor: pointer;
      }

      /* ================= LIST/GRID LAYOUTS ================= */
      /* Horizontal Scroll (Home) */
      .brand-section {
        margin-bottom: 20px;
        padding: 10px 0;
      }
      .brand-title {
        padding: 0 15px;
        font-size: 1.1rem;
        font-weight: 800;
        text-transform: uppercase;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
      }
      .brand-see-all {
        font-size: 0.8rem;
        color: #888;
        text-decoration: underline;
        font-weight: normal;
        cursor: pointer;
      }

      .scroll-wrapper {
        display: flex;
        overflow-x: auto;
        gap: 10px;
        padding: 0 15px 15px 15px;
        scrollbar-width: none;
        -webkit-overflow-scrolling: touch;
      }
      .scroll-wrapper::-webkit-scrollbar {
        display: none;
      }

      .product-card {
        flex: 0 0 140px;
        display: flex;
        flex-direction: column;
        cursor: pointer;
      }
      .img-wrapper {
        width: 100%;
        height: 140px;
        border-radius: 8px;
        overflow: hidden;
        background: #f9f9f9;
        position: relative;
        margin-bottom: 8px;
      }
      .img-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      .card-title {
        font-size: 0.85rem;
        font-weight: 600;
        line-height: 1.2;
        height: 2.4em;
        overflow: hidden;
        margin-bottom: 4px;
      }
      .card-brand {
        font-size: 0.75rem;
        color: #888;
      }

      /* Grid View */
      #grid-view {
        display: none;
        padding: 15px;
      }
      .gallery {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }
      @media (min-width: 600px) {
        .gallery {
          grid-template-columns: repeat(4, 1fr);
        }
      }
      .grid-item {
        background: #fff;
      }

      /* ================= UI ELEMENTS ================= */
      /* Add Button Styles */
      .btn-add {
        background: #000;
        color: #fff;
        width: 100%;
        padding: 8px 0;
        font-size: 0.8rem;
        font-weight: 700;
        border-radius: 4px;
        margin-top: 5px;
        cursor: pointer;
      }
      .qty-control {
        display: flex;
        align-items: center;
        justify-content: space-between;
        border: 1px solid #000;
        border-radius: 4px;
        height: 32px;
        margin-top: 5px;
      }
      .qty-control div {
        width: 30px;
        text-align: center;
        cursor: pointer;
        font-weight: bold;
      }
      .qty-val {
        flex: 1;
        text-align: center;
        font-size: 0.9rem;
      }

      /* Tags */
      .tag {
        position: absolute;
        top: 0;
        left: 0;
        padding: 2px 6px;
        font-size: 0.65rem;
        color: #fff;
        font-weight: bold;
      }
      .tag.hot {
        background: #d9534f;
      }
      .tag.new {
        background: #007bff;
      }

      /* ================= MODAL ================= */
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 3000;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .modal.open {
        display: flex;
      }
      .modal-content {
        background: #fff;
        width: 100%;
        max-width: 400px;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        padding-bottom: 20px;
      }
      .modal-close {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 1.5rem;
        width: 30px;
        height: 30px;
        background: #eee;
        border-radius: 50%;
        text-align: center;
        line-height: 28px;
        cursor: pointer;
        z-index: 10;
      }
      .modal-img-area {
        width: 100%;
        height: 300px;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .modal-img-area img {
        max-width: 80%;
        max-height: 90%;
      }
      .modal-info {
        padding: 15px;
        text-align: center;
      }

      /* ================= BOTTOM BAR ================= */
      .bottom-bar {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 400px;
        height: 60px;
        background: #222;
        color: #fff;
        border-radius: 30px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 6px 0 20px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        z-index: 2500;
        cursor: pointer;
      }
      .bar-info {
        font-size: 0.95rem;
        font-weight: 600;
      }
      .bar-btn {
        background: #fff;
        color: #000;
        height: 48px;
        padding: 0 25px;
        border-radius: 24px;
        font-weight: 700;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
      }

      /* Skeleton */
      .skeleton {
        background: #f0f0f0;
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
        100% {
          opacity: 1;
        }
      }

      /* Toast */
      #toast {
        position: fixed;
        bottom: 90px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 10px 20px;
        border-radius: 20px;
        opacity: 0;
        transition: 0.3s;
        pointer-events: none;
        z-index: 4000;
        font-size: 0.9rem;
      }
      #toast.show {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="header-left" id="menu-trigger">â˜°</div>
      <div class="header-center">
        <input
          type="text"
          id="search-input"
          class="header-search-input"
          placeholder="Search catalog..."
        />
      </div>
      <div
        class="header-right"
        onclick="window.location.href = 'cart.html'"
        style="position: relative; width: 30px"
      >
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="black"
          stroke-width="2"
          width="24"
          height="24"
        >
          <path
            d="M6 6h15l-1.68 13.39a2 2 0 0 1-2 1.61H6a2 2 0 0 1-2-1.61L2.34 6H1V4h4l1 2z"
          ></path>
        </svg>
      </div>
    </header>

    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <div class="sidebar" id="sidebar">
      <div style="font-weight: 900; font-size: 1.2rem; margin-bottom: 20px">
        CATEGORIES
      </div>
      <nav>
        <a class="menu-link" onclick="loadView('Home')">Home</a>
        <a class="menu-link" onclick="loadView('All')">Full Catalog</a>
        <a class="menu-link" onclick="loadView('Gender:Women')">For Her</a>
        <a class="menu-link" onclick="loadView('Gender:Men')">For Him</a>
        <a class="menu-link" onclick="loadView('Gender:Unisex')">Unisex</a>
        <a class="menu-link" onclick="loadView('Set')">Gift Sets</a>
      </nav>
      <div
        style="
          margin-top: 20px;
          font-weight: 700;
          color: #999;
          font-size: 0.85rem;
        "
      >
        BRANDS
      </div>
      <div id="sidebar-brands"></div>
    </div>

    <div id="home-view"></div>

    <div id="grid-view">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 15px;
        "
      >
        <h2 id="grid-title" style="margin: 0; font-size: 1.2rem">Results</h2>
        <span
          onclick="loadView('Home')"
          style="font-size: 0.9rem; text-decoration: underline"
          >Back</span
        >
      </div>
      <div class="gallery" id="gallery"></div>
      <div id="pagination" style="margin-top: 20px; text-align: center"></div>
    </div>

    <div
      class="bottom-bar"
      id="bottom-bar"
      style="display: none"
      onclick="window.location.href = 'cart.html'"
    >
      <div class="bar-info"><span id="bar-count">0</span> Items Selected</div>
      <button class="bar-btn">VIEW LIST &rarr;</button>
    </div>

    <div id="modal" class="modal">
      <div class="modal-content">
        <div class="modal-close">&times;</div>
        <div class="modal-img-area">
          <img id="modal-img" src="" alt="" />
        </div>
        <div class="modal-info">
          <div
            style="
              font-size: 0.8rem;
              color: #888;
              font-weight: bold;
              letter-spacing: 1px;
            "
            id="modal-brand"
          >
            BRAND
          </div>
          <h3 id="modal-title" style="margin: 5px 0 10px 0; font-size: 1.2rem">
            Product Name
          </h3>
          <div
            id="modal-meta"
            style="font-size: 0.9rem; color: #666; margin-bottom: 15px"
          ></div>
          <div
            id="modal-notes"
            style="
              font-size: 0.85rem;
              font-style: italic;
              background: #f9f9f9;
              padding: 8px;
              border-radius: 6px;
              margin-bottom: 15px;
            "
          ></div>
          <div id="modal-stock-msg"></div>
          <div id="modal-action-area" style="margin-top: 15px"></div>
        </div>
      </div>
    </div>

    <div id="toast">Added to Selection</div>

    <script src="db.js"></script>
    <script>
      // ================= CONFIG =================
      const FEATURED_BRANDS = [
        "Creed",
        "Dior",
        "Chanel",
        "Tom Ford",
        "Louis Vuitton",
        "Gucci",
        "Maison Francis Kurkdjian",
        "Parfums de Marly",
        "Jean Paul Gaultier",
        "Xerjoff",
        "Bond No. 9",
        "Initio",
      ];
      let cartItems = [];
      let viewMode = "home";
      let currentGridData = [];
      let currentPage = 1;

      // ================= INIT =================
      document.addEventListener("DOMContentLoaded", () => {
        setupUI();
        loadCart();
        // db.js calls runPageLogic when done
      });

      function runPageLogic() {
        renderSidebar();
        renderHome();
        checkUrlForSku(); // <--- Deep Linking Logic
      }

      // ================= DEEP LINKING (SKU) =================
      function checkUrlForSku() {
        const params = new URLSearchParams(window.location.search);
        const sku = params.get("sku");
        if (sku && window.perfumeDB) {
          // Try to find by Exact ID or Name starts with ID
          const item = window.perfumeDB.find(
            (p) => p.id == sku || p.name.startsWith(sku),
          );
          if (item) {
            openModal(item);
            // Optional: Clean URL so reload doesn't keep opening it?
            // window.history.replaceState({}, document.title, window.location.pathname);
          }
        }
      }

      // ================= RENDERING =================
      function renderHome() {
        const container = document.getElementById("home-view");
        container.innerHTML = "";

        const db = window.perfumeDB.filter((p) => parseInt(p.stock) > 0); // Hide OOS

        // 1. Hot Items
        const hot = db.filter((p) => p.top == 1).slice(0, 10);
        if (hot.length)
          container.appendChild(createSection("Trending Now", hot));

        // 2. Featured Brands
        FEATURED_BRANDS.forEach((brand) => {
          const items = db.filter((p) =>
            p.brand.toLowerCase().includes(brand.toLowerCase()),
          );
          if (items.length >= 4) {
            container.appendChild(
              createSection(brand, items.slice(0, 15), brand),
            );
          }
        });
      }

      function createSection(title, items, linkKey) {
        const sec = document.createElement("div");
        sec.className = "brand-section";
        sec.innerHTML = `
          <div class="brand-title">
             <span>${title}</span>
             <span class="brand-see-all" onclick="loadView('${linkKey || "All"}')">See All</span>
          </div>
        `;
        const wrapper = document.createElement("div");
        wrapper.className = "scroll-wrapper";

        items.forEach((p) => {
          const card = document.createElement("div");
          card.className = "product-card";
          card.onclick = (e) => {
            if (e.target.closest("button") || e.target.closest(".qty-control"))
              return;
            openModal(p);
          };

          // Generate Action Button
          const btnHtml = getButtonHtml(p.id);
          const webp = p.img.replace(/\.(jpg|png)$/i, ".webp");

          let tag = "";
          if (p.top == 1) tag = '<div class="tag hot">HOT</div>';
          else if (p.new == 1) tag = '<div class="tag new">NEW</div>';

          card.innerHTML = `
             <div class="img-wrapper">
                <picture><source srcset="${webp}"><img src="${p.img}" loading="lazy"></picture>
                ${tag}
             </div>
             <div class="card-title">${p.caption || p.id + " " + p.name}</div>
             <div class="card-brand">${p.brand} ${p.ml ? "Â· " + p.ml : ""}</div>
             <div id="btn-${p.id}">${btnHtml}</div>
           `;
          wrapper.appendChild(card);
        });
        sec.appendChild(wrapper);
        return sec;
      }

      function loadView(key) {
        document.getElementById("sidebar").classList.remove("active");
        document.getElementById("sidebar-overlay").classList.remove("active");

        if (key === "Home") {
          document.getElementById("home-view").style.display = "block";
          document.getElementById("grid-view").style.display = "none";
          window.scrollTo(0, 0);
          return;
        }

        // Switch to Grid
        document.getElementById("home-view").style.display = "none";
        document.getElementById("grid-view").style.display = "block";
        window.scrollTo(0, 0);

        let data = window.perfumeDB.filter((p) => parseInt(p.stock) > 0);
        let title = key;

        if (key === "All") {
          title = "Full Catalog";
        } else if (key.startsWith("Gender:")) {
          const g = key.split(":")[1];
          data = data.filter(
            (p) => p.gender && p.gender.toLowerCase().includes(g.toLowerCase()),
          );
          title = g + "'s Selection";
        } else if (key === "Set") {
          data = data.filter((p) => p.name.toUpperCase().includes("SET"));
          title = "Gift Sets";
        } else if (key.startsWith("Search:")) {
          const term = key.split(":")[1].toLowerCase();
          data = data.filter(
            (p) =>
              p.name.toLowerCase().includes(term) ||
              p.brand.toLowerCase().includes(term) ||
              p.id.toString().includes(term),
          );
          title = `Search: "${term}"`;
        } else {
          // Brand
          data = data.filter((p) =>
            p.brand.toLowerCase().includes(key.toLowerCase()),
          );
        }

        currentGridData = data;
        currentPage = 1;
        document.getElementById("grid-title").textContent = title;
        renderGrid();
      }

      function renderGrid() {
        const gal = document.getElementById("gallery");
        gal.innerHTML = "";
        const size = 20;
        const start = (currentPage - 1) * size;
        const pageItems = currentGridData.slice(start, start + size);

        if (pageItems.length === 0) {
          gal.innerHTML =
            "<div style='grid-column:1/-1;text-align:center;padding:40px;color:#999'>No items found</div>";
          return;
        }

        pageItems.forEach((p) => {
          const div = document.createElement("div");
          div.className = "grid-item";
          div.innerHTML = `
              <div class="img-wrapper" style="height:160px" onclick="openModalById('${p.id}')">
                <img src="${p.img}" loading="lazy" style="object-fit:contain">
              </div>
              <div style="padding:5px;">
                 <div style="font-size:0.8rem;height:2.4em;overflow:hidden;font-weight:600;">${p.name}</div>
                 <div style="font-size:0.75rem;color:#777;">${p.brand}</div>
                 <div id="grid-btn-${p.id}">${getButtonHtml(p.id)}</div>
              </div>
           `;
          gal.appendChild(div);
        });

        // Pagination (Simple)
        const totalPages = Math.ceil(currentGridData.length / size);
        const pagDiv = document.getElementById("pagination");
        pagDiv.innerHTML = "";
        if (totalPages > 1) {
          if (currentPage > 1)
            pagDiv.innerHTML += `<button onclick="currentPage--;renderGrid()" style="padding:10px;background:#eee;margin:5px;">Prev</button>`;
          pagDiv.innerHTML += `<span style="margin:0 10px;">Page ${currentPage} / ${totalPages}</span>`;
          if (currentPage < totalPages)
            pagDiv.innerHTML += `<button onclick="currentPage++;renderGrid()" style="padding:10px;background:#eee;margin:5px;">Next</button>`;
        }
      }

      // ================= ACTIONS =================
      window.updateQty = (id, change) => {
        const p = window.perfumeDB.find((i) => i.id == id);
        if (!p) return;

        let item = cartItems.find((c) => c.name === id);
        if (!item) {
          if (change > 0) {
            cartItems.push({
              name: id,
              caption: `${id} - ${p.name}`,
              img: p.img,
              brand: p.brand,
              quantity: 1,
            });
            showToast("Added to List");
          }
        } else {
          item.quantity += change;
          if (item.quantity <= 0)
            cartItems = cartItems.filter((c) => c.name !== id);
        }

        saveCart();
        refreshButtons(id);
      };

      function refreshButtons(id) {
        const html = getButtonHtml(id);
        const els = document.querySelectorAll(`[id*='btn-${id}']`); // Matches home, grid, modal
        els.forEach((el) => (el.innerHTML = html));
        if (document.getElementById("modal").classList.contains("open")) {
          document.getElementById("modal-action-area").innerHTML = html;
        }
      }

      function getButtonHtml(id) {
        const item = cartItems.find((c) => c.name == id);
        if (!item)
          return `<button class="btn-add" onclick="updateQty('${id}', 1)">ADD TO LIST</button>`;
        return `
           <div class="qty-control">
              <div onclick="updateQty('${id}', -1)">-</div>
              <div class="qty-val">${item.quantity}</div>
              <div onclick="updateQty('${id}', 1)">+</div>
           </div>
         `;
      }

      window.openModal = (p) => {
        const m = document.getElementById("modal");
        document.getElementById("modal-img").src = p.img;
        document.getElementById("modal-brand").textContent = p.brand;
        document.getElementById("modal-title").textContent =
          p.id + " - " + p.name;
        document.getElementById("modal-meta").innerHTML =
          `${p.gender || "Unisex"} Â· ${p.ml || "Standard Size"}`;

        const notes = p.Notes || p.notes || "";
        const nEl = document.getElementById("modal-notes");
        if (notes) {
          nEl.style.display = "block";
          nEl.textContent = "Notes: " + notes;
        } else nEl.style.display = "none";

        // Stock Logic (No price)
        const stock = parseInt(p.inventory || p.stock);
        const sEl = document.getElementById("modal-stock-msg");
        if (stock < 10)
          sEl.innerHTML = `<span style="color:#d9534f;font-size:0.8rem;font-weight:bold;">ðŸ”¥ Low Stock: Only ${stock} left</span>`;
        else
          sEl.innerHTML = `<span style="color:#28a745;font-size:0.8rem;font-weight:bold;">âœ… In Stock</span>`;

        document.getElementById("modal-action-area").innerHTML = getButtonHtml(
          p.id,
        );
        m.classList.add("open");
      };

      window.openModalById = (id) => {
        const p = window.perfumeDB.find((x) => x.id == id);
        if (p) openModal(p);
      };

      // ================= UTILS =================
      function loadCart() {
        cartItems = JSON.parse(localStorage.getItem("perfumeCart") || "[]");
        updateBottomBar();
      }
      function saveCart() {
        localStorage.setItem("perfumeCart", JSON.stringify(cartItems));
        updateBottomBar();
      }
      function updateBottomBar() {
        const qty = cartItems.reduce((a, b) => a + b.quantity, 0);
        const bar = document.getElementById("bottom-bar");
        if (qty > 0) {
          bar.style.display = "flex";
          document.getElementById("bar-count").textContent = qty;
        } else {
          bar.style.display = "none";
        }
      }
      function showToast(msg) {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 2000);
      }

      // Sidebar & UI Helpers
      document.querySelector(".modal-close").onclick = () =>
        document.getElementById("modal").classList.remove("open");
      document.getElementById("menu-trigger").onclick = () => {
        document.getElementById("sidebar").classList.add("active");
        document.getElementById("sidebar-overlay").classList.add("active");
      };
      document.getElementById("sidebar-overlay").onclick = () => {
        document.getElementById("sidebar").classList.remove("active");
        document.getElementById("sidebar-overlay").classList.remove("active");
      };
      document
        .getElementById("search-input")
        .addEventListener("change", (e) =>
          loadView("Search:" + e.target.value),
        );

      function renderSidebar() {
        const div = document.getElementById("sidebar-brands");
        div.innerHTML = "";
        FEATURED_BRANDS.forEach((b) => {
          div.innerHTML += `<div class="brand-item" onclick="loadView('${b}')">${b}</div>`;
        });
      }
    </script>
  </body>
</html>
